<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Publisher</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Paho-MQTT JavaScript Client CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-lg shadow-lg max-w-lg w-full">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Paho-MQTT Publisher</h1>

        <!-- Connection Status Section -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Connection Status</h2>
            <div id="status" class="p-3 bg-blue-100 text-blue-800 rounded-md font-medium text-center">Disconnected</div>
        </div>
        
        <!-- Input Fields -->
        <div class="mb-6">
            <label for="topic" class="block text-gray-700 font-medium mb-2">MQTT Topic</label>
            <input type="text" id="topic" value="TCFST/Robot1" placeholder="Enter topic name..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-6">
            <label for="message" class="block text-gray-700 font-medium mb-2">Message Payload</label>
            <textarea id="message" rows="4" placeholder="Enter message to publish..."
                      class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-4 mb-6">
            <button id="connectBtn"
                    class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                Connect
            </button>
            <button id="publishBtn" disabled
                    class="flex-1 bg-green-500 text-white font-semibold py-2 px-4 rounded-md opacity-50 cursor-not-allowed hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                Publish
            </button>
        </div>

        <!-- Log Area -->
        <div>
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Log</h2>
            <div id="log" class="bg-gray-200 text-gray-900 p-4 rounded-md h-48 overflow-y-auto font-mono text-sm">
                Awaiting connection...
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // Global variables for MQTT client
        let client = null;
        let isConnected = false;

        // Get references to DOM elements
        const connectBtn = document.getElementById('connectBtn');
        const publishBtn = document.getElementById('publishBtn');
        const statusDiv = document.getElementById('status');
        const topicInput = document.getElementById('topic');
        const messageInput = document.getElementById('message');
        const logDiv = document.getElementById('log');

        // Broker settings
        const host = "test.mosquitto.org";
        const port = 8081; // Default port for secure websockets
        const clientId = "mqtt_publisher_" + Math.random().toString(16).substr(2, 8); // Unique client ID

        // Function to update the UI based on connection status
        function updateUI(status) {
            isConnected = status;
            if (isConnected) {
                statusDiv.textContent = 'Connected';
                statusDiv.classList.remove('bg-blue-100', 'text-blue-800', 'bg-red-100', 'text-red-800');
                statusDiv.classList.add('bg-green-100', 'text-green-800');
                connectBtn.textContent = 'Disconnect';
                publishBtn.disabled = false;
                publishBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                publishBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                statusDiv.classList.add('bg-blue-100', 'text-blue-800');
                connectBtn.textContent = 'Connect';
                publishBtn.disabled = true;
                publishBtn.classList.add('opacity-50', 'cursor-not-allowed');
                publishBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            }
        }

        // Function to log messages to the log area
        function log(message) {
            const now = new Date();
            const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timeString}] ${message}`;
            logDiv.prepend(logEntry);
        }

        // Connect to the MQTT broker
        function connect() {
            log(`Attempting to connect securely (WSS) to ${host}:${port}...`);
            client = new Paho.MQTT.Client(host, Number(port), "/ws", clientId);

            // Set up event handlers
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            client.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                useSSL: true,
                cleanSession: true
            });
        }

        // Callback for successful connection
        function onConnect() {
            log("Connection successful!");
            updateUI(true);
        }

        // Callback for connection failure
        function onFailure(responseObject) {
            log(`Connection failed: ${responseObject.errorMessage}`);
            statusDiv.textContent = 'Failed to Connect';
            statusDiv.classList.remove('bg-blue-100', 'text-blue-800');
            statusDiv.classList.add('bg-red-100', 'text-red-800');
            updateUI(false);
        }

        // Callback for connection lost
        function onConnectionLost(responseObject) {
            if (responseObject.wasConnected) {
                log("Connection lost!");
            }
            updateUI(false);
        }

        // Callback for incoming messages (not used for this publisher, but good to have)
        function onMessageArrived(message) {
            log(`Received message on topic "${message.destinationName}": ${message.payloadString}`);
        }

        // Publish a message
        function publishMessage() {
            const topic = topicInput.value;
            const payload = messageInput.value;

            if (!client || !client.isConnected()) {
                log("Error: Not connected to the broker.");
                return;
            }

            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;

            try {
                client.send(message);
                log(`Published message to topic "${topic}": ${payload}`);
            } catch (error) {
                log(`Publish failed: ${error.message}`);
            }
        }

        // Event listeners for buttons
        connectBtn.addEventListener('click', () => {
            if (isConnected) {
                client.disconnect();
                updateUI(false);
                log("Disconnected from the broker.");
            } else {
                connect();
            }
        });
        
        publishBtn.addEventListener('click', publishMessage);

    </script>
</body>
</html>
